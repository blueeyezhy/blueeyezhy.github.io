# 实践总结13--自动化交易实践总结

这一个多月，用 Python 和 JavaScript 实践了自动化数字货币的交易，事情告一段落做个总结。

过程中合计进行了47个版本的迭代，全部代码重构进行了3次。过程中有写代码到吐，有找不到 bug 的迷茫，有测试通过的兴奋，也有新想法通过代码实现，代码执行的喜悦；各中滋味都值得细细品味。



## 自动化交易



![auto_trade](https://src.seaky.club/img/auto_trade.png)

如上图，自动化交易就是：在托管服务器上运行一个交易机器人，执行特定的交易策略，自动控制交易账户，获取交易收益的过程。  

其中各个要素内容说明如下：

* **托管服务器**：

  24小时不间断运行交易机器人的电脑，需要安装特定的运行环境以支持交易机器人运行；如果策略是用 Python2 编写的，就需要有 Python2环境；如果策略是Python3编写的，就需要Python3环境；同样如果策略是 JavaScript 编写的就需要 Nodejs 环境来运行。

* **交易机器人**：

  支持量化交易平台的一套接口程序，是用户策略和各交易所之间的中间层；用户只需要配置好交易所的API key，然后直接调用交易机器人的接口，而无需分别管理各个交易所的API来获取信息和执行操作；这样用户就可以专注于自己策略的有效性，而不用关注底层与各个交易所之间的请求和执行操作。

  市场上有很多这样类似的交易机器人平台，我现在使用的是 [发明者量化交易平台](https://www.fmz.com/sign-up/2866348) ，费用不高容易上手。

* **交易策略**：

  自动化交易的核心，赚钱与否直接取决于策略的有效性。策略主要分为下面两类：

  1. **套利**：不做预测；仅通过获取当前报价和深度信息，寻找市场价格瞬时差异，进行高卖低买的操作，以获取收益；由于套利的存在，不同的价格会被迅速填平，市场价格回归稳定。套利是提升市场有效性的有效手段。

     主要有交易所间搬砖套利，三角套利等等； 其风险在于交易是否可以同时进行，如果单个交易所拔网线，就会掉到坑里。

  2. **趋势策略**：用历史的数据预测未来，提前埋伏以获取预期收益的方式（依据历史数据计算出的预期）；关键点是寻找到与价格变化相关的某个前置指标，根据前置指标推测出价格的大概率变化方向，然后提前操作。

     主要的趋势策略有MACD，移动均值策略，布林带等等；其风险在于历史并不完全等于未来，存在概率上的失误。

* **交易所-交易对儿**：

  策略交易的标的。比如火币以BTC结算的BTC指数永续合约；再比如 Bigone 的 EOS_BTC，以BTC计价的EOS等等。不同交易标的，价格变化不同，历史数据不同，交易策略以及策略参数也就不同。

  寻找到某个交易对适合的交易策略及参数是策略有效的关键，这是建立在交易经验，数据分析等基础之上的，需要花很多功夫。
  
  

## 交易策略的开发

交易策略的开发流程大致如下：

前期调研 => 数据分析 => 策略方案定型 => 策略编写 => 模拟回测 => 小金额实盘测试 => 实盘执行（服务器迁移） => 定期优化参数 =>  实盘执行 => 定期优化参数 => ……

* **前期调研 => 数据分析 => 策略方案定型**

  这一步是寻找与价格变化相关的前置指标，寻找出拐点（未来埋伏操作的变化点）；比如说5日均线，20日均线，100日均线的交叉点；再比如说 MACD 中的 DIF 和 DEA 交点；再比如价格穿布林曲线的上线或者下线等等；然后确定利用那个前置指标作为交易信号，明确策略的方案。

*  **策略编写 => 模拟回测** 

  这两步几乎是同时循环进行的，类似于测试驱动的编程；从学习践行编程的角度来讲，的是践行编程的最主要部分，需要将我们学过模块化，数据结构、变量定义、分支循环、异步并发有机的结合起来，一个功能一个功能的完成策略的编写。

* **小金额实盘测试**

  策略编写及模拟回测完成后，就需要链接真实的交易所进行实盘测试，以寻找策略中实盘bug并修复同时检验策略的有效性，这是一般用平台的公用服务器作为托管者。比如说向交易所请求数据的时间间隔是否有问题；是否可以有效下单，有效交易；多交易所时，异步操作是否有效等等。

* **实盘执行（服务器迁移）**

  经过了上面的测试之后，就可以租用或者购买私人的服务器托管机器人，进行实盘自动交易了。私人服务器时专门自己用的，比平台公用服务器更稳定，更能保证策略的执行。

* **定期优化参数 =>  实盘执行 => 定期优化参数 => ……**

  策略本身是由时效性的，不同的时间段，价格变化不同，收益结果也就不同；所以策略的参数也是有时效性的，必须定期重新评估和调整。比如说均仓策略的价格变化阈值，在价格变动剧烈的时候可以调大一点；再比如移动均值周期小一些，对价格变化就会更敏感些等等。

  

## 心得所感

1. **写代码前的分析和规划很重要**

   对于新程序猿，一个需求来了往往一上来就写代码，编函数。开始的时候我也是的，一上来就写函数，需要了再添加全局变量，根本没有进行规划。但是这样的代码，当新需求一来，就傻了，相当于重新再写了一遍。所以分析规划很重要，我最后一次重构代码的时候，采用面向对象的方式实现；把整个策略分为：初始化模块、循环获取信息模块、策略信号计算模块（计算出买入还是卖出的信号）、交易执行模块四个部分；相互独立，通过类属性和少量的形参来进行参数的传递。之后无论是debug，还是增加需求就可以快速定位，快速迭代。

2. **对象式（类架构）vs 函数式（函数架构）**

   最开始的策略是通过函数来实现的，功能虽然实现了，但是对于参数的传递和管理上比较乱，封装复用性不是很好；后来使用类方式实现后，清爽多了，扩展到其他策略也非常容易。但是代码量比函数式要多一些。个人偏好面向对象的方式。

3. **全局变量命名与规划**

   全局变量的规划很重要，要与平台的全局变量区分开；比如 exchanges 是交易平台的全局变量，我们策略代码中最好用 `self.excs` 代替，这样如果漏写了 `self` 就可以及时发现错误。用 `self.exchanges` 的话，如果漏写了 `self` ，机器人会默认调用平台的全局变量，以至于需要到实盘时才会发现错误。全局变量（属性）的使用要仔细，每次赋值修改的时候，都要特别注意确认是否影响到其他函数。

4. **版本管理，更新迭代**

   版本管理要精细，只允许添加，并留下所有的履历；每一次变化都要明确记录和备份。这点很重要会避免不必要的时间和查找精力的浪费。特别是多版本并行的时候。

5. **关键点和关键信息的输出**

   在代码中关键点添加Log输出信息，关键信息也要用Log输出，在测试或者运行中会帮助你定位问题和监控进度

6. **异步与同步**

   一定要明确异步和同步的使用，比如说一个策略管理多个账户的时候，当交易信号出现后，一定要用异步的方式同时执行多个账号；而信号出现后一定要先平仓，然后再开仓，这一定要用同步的顺序执行，平仓不完成不允许开仓。

7. 一个多月的高密度编程实践，过程中遇到很多问题也解决了很多问题，同时自我感觉成长的很多。

   还有一点，遇到一个弄了很久也无法解决的问题的时候，放松一下洗个碗，通常就会柳暗花明，新的思路。

---

**定投践行社区**里面有李俊老师的**Python编程课**，刘晓艳老师的**英文课**(正在讲的是《**beyond feelings**》)，廖智小姐姐的幸福力(**汶川地震30小时深埋地下的感悟**)，老虎证券王珊老师的**读财报课**，还有李笑来老师的**写作课**和**定投课**，**定投时间**超值体验如果你也想加入，注册 [**Mixin**](https://mixin.one/messenger) 加我(ID: **21120**)好友，送你邀请码。

**注:** 践行社区是建立在 [**Mixin Massager**](https://mp.weixin.qq.com/s/ci_OWj9vtnsJ4OROifNfSQ) 上的社群，所以你必须学会使用 Mixin  Massager ；同时践行社区是封闭课程社区没有邀请码不能加入。)