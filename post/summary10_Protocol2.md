# 互联网信息的传输--学习总结(十)

> - **PressOne**: [张野](https://press.one/main/p/7c08521960497a61baf3f1c9760ff2a4cc66be1c)
> - [**Mixin**](https://mixin.one/) ID: 21120;  **bot**: 7000102888
> - **Github**: [@blueeyezhy](https://github.com/blueeyezhy)
> - **web**: [blueeye.run](http://blueeye.run/)

## 互联网信息的传输   
接着上一篇，互联网通讯就是依靠一系列协议玩儿俄罗斯套娃，打包拆包的过程。还记得我们的数据包（下图）吗？每一层都是什么？又是怎么在互联网上传播的呢？

![数据包](https://static.press.one/30/fe/30fe2b6e1ae7b621280c149b1021c7cc980088f5ccb9ad8e3aaef06ead43f6ed.png)

## 开放式系统互联OSI模型   
根据开放式系统互联OSI模型，我们的数据是通过7层包装之后才能够在互联网上传播的。

1. **物理层**：信息传输的物理载体   
    * **传输介质**：电缆，光缆，无线电波（传输速度，帧大小，带宽）  
    * **链接接口（DCE）**：猫，光猫，通讯芯片及天线等
    * **数据终端（DTE）**：计算机，服务器，手机，pad，路由器等  
    * **数据传输物理过程**：DTE -> DCE -> 传输介质 -> DCE -> DTE
    * **数据单位**：比特流（bit）；高低电压，强弱光，高低频电波代表1和0  

2. **数据链路层**：信息传递双方之间一对一的物理通讯联络；包含物理地址寻址，建立链接，标识，分离，拆除链接；将比特流分组为帧数据包，对每帧数据进行检错，重发；以及流量控制
    * **MAC地址**：23:93:8D:0A:33:9C (6个字节48位)；是物理地址，烧在网卡芯片上，唯一不可改。网卡只能识别MAC地址，所以必须知道双方的MAC地址，才能建立链路层进行通讯。（导航定位也来源于这个物理网卡的定位）
    * **物理设备**：网卡，交互机，网桥，猫的一部分，路由器种的一部分
    * **数据单位**：帧（frame），包含帧定界，帧同步，帧顺序控制，帧差错检验和恢复   
	（例）以太帧，包含**Head**：18字节（其中包含源MAC地址6字节，目标MAC地址6字节，数据类型6字节）和**data**：最少46个字节，最大1500个字节。所以，一个以太帧封装最少64个字节，最大1518个字节。
    * **ARP协议**：Address Resolution Protocol：地址解析协议是根据IP地址获取MAC物理地址的一个协议。主机发送信息时，将包含目标IP地址的ARP请求，广播到网络上的所有主机，并接收返回消息，以此确定目标IP的MAC物理地址。
    * **RARP协议**：反向ARP协议，根据MAC物理地址获取IP地址的协议。

3. **网络层**：信息传递多方，多对多的虚拟链接；源站点和目标站点网络选择，链接与管理
    * **分时分频复用**：一条数据链路上复用多条网络链接
    * **路由器**：激活，终止虚拟网络链接，流量控制，信息排序；差错检验与恢复
    * **IP地址（逻辑地址）** 如，185.199.110.153（32位）；一个MAC地址可对应多个IP地址；具有全网范围内的寻址能力，可以快速定位目标地址所在的网络
    * **域名**：如，seaky.club（通过DNS解析，获取其对应的IP，比IP方便记忆，传播）
    * **IP数据包**：包含IP头在内，数据包最大长度65535字节。IP头文件包含源IP地址，目标IP地址，及一组校验数据。

4. **传输层**：最终用户之间端口对端口的链接；为会话层提供可靠，无误的数据传输及流量控制；数据分流合流，链接复用解复用，差错恢复协议，无差错回复协议，调节子网差异；传输层以下由操作系统封装头文件进行数据的打包，上层仅需调用即可
    * **工作阶段**
        > **链接的建立阶段**：三次握手协议，四次握手协议（socket建立）  
        > **数据的传输阶段**：一般数据传输以及加速数据传输   
        > **传输链接释放阶段**：链接释放（socket结束）   

    * **端口**：一个IP地址可对应多个端口，端口最多65536个，编号0~65535
    * **端口协议**：规定软件协议在计算机的位置；http(80)；https(443)等，（DNS解析，与端口一对一）
    * **数据包协议**，根据传输质量，速度，费用的平衡选择协议
        > **TCP协议**：段（segments）安全，数据量大，慢，（HTTP，FTP等）   
        > **UDP协议**：数据报（datagrams）快，数据量小，安全性差（DNS，QQ，微信等）

5. **会话层**：为对话实体（应用）建立链接，会话地址映射为传输地址；开始，控制，结束会话；分布处理，对话管理，信息表示，同步与异步传输，断点重连，恢复通讯等
    * **会话过程**：将会话数据单元转变成协议数据单元的过程。
    * **应用之间的链接**：APP-服务器-APP；浏览器-服务器-浏览器；APP-APP
    * **APP/浏览器**：发送请求（get，post等方法），与服务器链接，通讯
    * **服务器**：响应请求，验证用户，登录，建立维护通讯

6. **表示层**：数据格式转换，编码，解码，加密，解密等
    数据（文本，图片，声音，视频，压缩数据，密文）编码传输，解码显示的过程。主要由程序员通过编程来实现。

7. **应用层**：为应用进程提供服务，建立维持通讯
    实现多个系统应用进程相互通讯的同时，完成一系列业务处理所需的服务    
    * **虚拟终端**：作业传送与操作，文卷传送及访问管理，远程数据库访问，图形核心系统，开放系统互连管理等     
    * **常见应用**：WebAPP（B/S）；MobileAPP（C/S）；DesktopAPP（C/S）；服务器（S）	

## 我们来模拟一下，一条信息a从终端A走到终端B的过程  
假设最短路径为：终端A->网关A->路由C->网关B->终端B（http://seaky.club）  

1. 信息a要打包发送，必须要知道终端B的端口，IP，MAC地址  
2. DNS解析目标域名获得终端B的IP和端口；http://seaky.club => 185.199.110.153:80  
3. 查看终端A自己的ARP列表，寻找IP对应的MAC地址，发现没有  
4. 不确定终端A与终端B在一个网关，于是通过自己的MAC地址全网关内发出广播，问谁是这个IP，没回应
5. 说明不在一个网关，于是获取网关A的内网IP，端口，和MAC地址，将信息打包发给网关A
6. 网关A接到数据包，拆包获取目标域名，DNS解析获得IP地址，全网查找发现网关B是该IP地址映射，最短路径要经过路由C
7. 网关A获取路由C的端口，IP和MAC；替换信息头，重新打包发给路由C
8. 路由C接到数据，拆包获取目标域名，DNS解析获得IP地址，全网查找发现网关B是IP地址映射
9. 路由C获取网关B的端口，IP和MAC；替换信息头，重新打包发给网关B
10. 网关B接到数据，拆包获取目标域名，是自己，但是链接数据在内网终端B上
11. 网关B获取终端B的端口，IP和MAC；替换信息头，重新打包发给终端B
12. 终端B接到信息，拆包获得数据，处理数据
13. 返回数据时，原路返回只需替换源和目的的端口，IP，MAC地址


**整个过程如下图：**  

![数据流](https://static.press.one/aa/f9/aaf92564ec465c852ac4139d804befbcaf6185a2fe5217444b365a7eecee5436.png)


**这中间，网关，路由，中继都会获取和修改信息头，也就有了封IP和穿透的能力，proxy代理服务也是通过这种方式实现的；同时他们也可以替换数据的内容，使用原来的信息头，假扮对手方实现中间人监听和攻击。**

## 所感   
1. 努力输出是快速学习，掌握知识的重要手段   
2. 学过的东西总会有用得上的地方，比如上大学时学的《信息论》《单片机原理》给我现在学习互联网通讯，web编程提供了坚实的基础

---
> [python学习总结(九)--PressOne Protocal](https://read.firesbox.com/posts/22129abc8b6989cd088b793ffe1096fa15a5eb3a3e17b9f97a19f4c6b67f3d1e)     
> [python学习总结(八)--Github 1 to 2](https://read.firesbox.com/posts/4c2e85b07c27665426ceaadc9a5b8905b34c11c3fa759e6a7067a7a48f4935e1)    
> [python学习总结(七)--Encryption and decryption-RSA](https://read.firesbox.com/posts/8ac4298f49b860f9ed6347f7c4a7acc85fa78a5483b79b88ba101eeba6775da1)    
> [python学习总结(六)--Encryption and decryption-DES](https://read.firesbox.com/posts/a5e467977c9a4f42947c6b5af2c5ed3e778fa3600d3f0def1284d51f60e7832b)    
> [python学习总结(五)--Encryption and decryption-1](https://read.firesbox.com/posts/88f057fa93c7f831e36014cd7b4538474c9f8ce4cb495cfd2535524c0ecbf033)    
> [python学习总结(四)--String parsing](https://read.firesbox.com/posts/7b71ead909c1b46fc5ac914e70d9d744a5bb019cf99757e28fcfc273d59c4671)   
> [python学习总结(三)--PyQt](https://read.firesbox.com/posts/d7b80845d7870c33960dc349b6b1765c4145e4afac3aac00f422b713ca8fa320)   
> [python学习总结(二)--Powershell](https://read.firesbox.com/posts/ffc76fa8634a3be98e4f7ca9e45d7b5b33a41a3f5374a8153eaa42daddd91997)  
> [python学习总结(一)](https://read.firesbox.com/posts/b4ebbc69f1e5e4ba1069f112dcfef65fd7238bce3c7a722fae78e0fb6976fe5c)  
---
**定投践行社区**里面有李俊老师的**Python编程课**，刘晓艳老师的**英文课**(正在讲的是《**beyond feelings**》)，廖智小姐姐的幸福力(**汶川地震30小时深埋地下的感悟**)，老虎证券王珊老师的**读财报课**，还有李笑来老师的**写作课**和**定投课**，**定投时间**超值体验如果你也想加入，注册 [**Mixin**](https://mixin.one/) 加我(ID: **21120**)好友，送你邀请码。

**注:** 践行社区是建立在 [**Mixin Massager**](https://mp.weixin.qq.com/s/ci_OWj9vtnsJ4OROifNfSQ) 上的社群，所以你必须学会使用 Mixin  Massager ；同时践行社区是封闭课程社区没有邀请码不能加入。)
